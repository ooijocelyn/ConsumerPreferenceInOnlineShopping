<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Intention Research Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .study-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin: 20px 0;
            transform: translateY(20px);
            animation: slideUp 0.6s ease forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 20px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
        }

        .product-display {
            text-align: center;
            padding: 30px;
            background: #f7fafc;
            border-radius: 12px;
            margin: 20px 0;
        }

        .product-image {
            width: 200px;
            height: 200px;
            background: #e2e8f0;
            border-radius: 12px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #718096;
            border: 2px dashed #cbd5e0;
        }

        .scenario-box {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(238, 90, 82, 0.3);
        }

        .scenario-box.certain {
            background: linear-gradient(135deg, #4ecdc4, #44a19c);
            box-shadow: 0 5px 15px rgba(68, 161, 156, 0.3);
        }

        .likert-scale {
            margin: 15px 0;
        }

        .likert-question {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .likert-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
        }

        .likert-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .likert-option input[type="radio"] {
            transform: scale(1.3);
            margin: 0;
        }

        .likert-option label {
            font-size: 12px;
            text-align: center;
            margin: 0;
            font-weight: normal;
        }

        .likert-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #718096;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 10px 0 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .step-indicator {
            text-align: center;
            margin-bottom: 20px;
            color: #718096;
            font-size: 14px;
        }

        .consent-text {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }

        .debriefing {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }

        .demographic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .study-card {
                padding: 20px;
            }
            
            .likert-options {
                flex-direction: column;
                gap: 10px;
            }
            
            .likert-option {
                flex-direction: row;
                width: 100%;
                justify-content: space-between;
            }
            
            .demographic-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="study-card">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-indicator" id="stepIndicator"></div>

            <!-- Step 1: Welcome -->
            <div class="step active" id="step1">
                <h1>Purchase Intention Research Study</h1>
                <h2>Welcome to Our Research Study</h2>
                <p>Thank you for your interest in participating in our research study about consumer purchase intentions. This study is being conducted to better understand how people make purchasing decisions.</p>
                <p><strong>What to expect:</strong></p>
                <ul style="margin: 20px 0; padding-left: 20px;">
                    <li>This study will take approximately 10-15 minutes to complete</li>
                    <li>You will be asked to provide demographic information</li>
                    <li>You will view a product scenario and answer questions about your purchase intentions</li>
                    <li>All responses are anonymous and confidential</li>
                </ul>
                <button class="btn" onclick="nextStep()">Continue to Consent Form</button>
            </div>

            <!-- Step 2: Informed Consent -->
            <div class="step" id="step2">
                <h2>Informed Consent Form</h2>
                <div class="consent-text">
                    <h3>Research Study: Consumer Purchase Intention</h3>
                    <p><strong>Purpose:</strong> This study aims to understand how consumers make purchase decisions under different product information conditions.</p>
                    
                    <p><strong>Procedures:</strong> You will be asked to complete a demographic questionnaire, view a product scenario, and answer questions about your purchase intentions using rating scales.</p>
                    
                    <p><strong>Time Commitment:</strong> Approximately 10-15 minutes.</p>
                    
                    <p><strong>Risks:</strong> There are no anticipated risks associated with participation in this study.</p>
                    
                    <p><strong>Benefits:</strong> While there are no direct benefits to you, your participation will contribute to our understanding of consumer behavior.</p>
                    
                    <p><strong>Confidentiality:</strong> All information collected will be kept confidential. Your responses will be anonymous and will not be linked to your personal identity.</p>
                    
                    <p><strong>Voluntary Participation:</strong> Your participation is entirely voluntary. You may withdraw from the study at any time without penalty.</p>
                    
                    <p><strong>Contact Information:</strong> If you have questions about this study, please contact [Researcher Contact Information].</p>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="consentCheck" required>
                    <label for="consentCheck">I have read and understood the information above. I voluntarily agree to participate in this research study.</label>
                </div>
                
                <button class="btn" onclick="nextStep()" id="consentBtn" disabled>I Agree - Continue</button>
                <button class="btn btn-secondary" onclick="window.close()">I Do Not Agree - Exit</button>
            </div>

            <!-- Step 3: Demographics -->
            <div class="step" id="step3">
                <h2>Demographic Information</h2>
                <p>Please provide the following information about yourself:</p>
                
                <div class="demographic-grid">
                    <div class="form-group">
                        <label for="age">Age:</label>
                        <input type="number" id="age" min="18" max="100" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <select id="gender" required>
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="education">Highest Education Level:</label>
                        <select id="education" required>
                            <option value="">Select...</option>
                            <option value="high-school">High School</option>
                            <option value="diploma">Diploma</option>
                            <option value="bachelors">Bachelor's Degree</option>
                            <option value="masters">Master's Degree</option>
                            <option value="phd">PhD</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="income">Monthly Income (RM):</label>
                        <select id="income" required>
                            <option value="">Select...</option>
                            <option value="below-2000">Below 2,000</option>
                            <option value="2000-4000">2,000 - 4,000</option>
                            <option value="4000-6000">4,000 - 6,000</option>
                            <option value="6000-8000">6,000 - 8,000</option>
                            <option value="above-8000">Above 8,000</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="occupation">Occupation:</label>
                        <input type="text" id="occupation" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="collectible-experience">How often do you purchase collectible items?</label>
                        <select id="collectible-experience" required>
                            <option value="">Select...</option>
                            <option value="never">Never</option>
                            <option value="rarely">Rarely</option>
                            <option value="sometimes">Sometimes</option>
                            <option value="often">Often</option>
                            <option value="very-often">Very Often</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="nextStep()" id="demographicsBtn" disabled>Continue</button>
            </div>

            <!-- Step 4: Product Scenario -->
            <div class="step" id="step4">
                <h2>Product Scenario</h2>
                <p>Please carefully read the following scenario and examine the product:</p>
                
                <div class="product-display">
                    <div class="product-image">
                        <div>Collectible Figure<br>(Product Image)</div>
                    </div>
                </div>
                
                <div class="scenario-box" id="scenarioBox">
                    <!-- Scenario text will be inserted here based on condition -->
                </div>
                
                <p>Please take a moment to consider this scenario before proceeding to the questions.</p>
                
                <button class="btn" onclick="nextStep()">Continue to Questions</button>
            </div>

            <!-- Step 5: Purchase Intention Scale -->
            <div class="step" id="step5">
                <h2>Purchase Intention Questions</h2>
                <p>Based on the scenario you just viewed, please rate your agreement with the following statements using the scale below:</p>
                
                <form id="purchaseIntentionForm">
                    <div class="likert-scale">
                        <div class="likert-question">1. I would consider buying this product.</div>
                        <div class="likert-options">
                            <div class="likert-option">
                                <input type="radio" name="q1" value="1" id="q1_1" required>
                                <label for="q1_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q1" value="2" id="q1_2">
                                <label for="q1_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q1" value="3" id="q1_3">
                                <label for="q1_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q1" value="4" id="q1_4">
                                <label for="q1_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q1" value="5" id="q1_5">
                                <label for="q1_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q1" value="6" id="q1_6">
                                <label for="q1_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q1" value="7" id="q1_7">
                                <label for="q1_7">7</label>
                            </div>
                        </div>
                        <div class="likert-labels">
                            <span>Strongly Disagree</span>
                            <span>Strongly Agree</span>
                        </div>
                    </div>

                    <div class="likert-scale">
                        <div class="likert-question">2. I would purchase this product if I had the opportunity.</div>
                        <div class="likert-options">
                            <div class="likert-option">
                                <input type="radio" name="q2" value="1" id="q2_1" required>
                                <label for="q2_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q2" value="2" id="q2_2">
                                <label for="q2_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q2" value="3" id="q2_3">
                                <label for="q2_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q2" value="4" id="q2_4">
                                <label for="q2_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q2" value="5" id="q2_5">
                                <label for="q2_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q2" value="6" id="q2_6">
                                <label for="q2_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q2" value="7" id="q2_7">
                                <label for="q2_7">7</label>
                            </div>
                        </div>
                        <div class="likert-labels">
                            <span>Strongly Disagree</span>
                            <span>Strongly Agree</span>
                        </div>
                    </div>

                    <div class="likert-scale">
                        <div class="likert-question">3. I have a strong intention to buy this product.</div>
                        <div class="likert-options">
                            <div class="likert-option">
                                <input type="radio" name="q3" value="1" id="q3_1" required>
                                <label for="q3_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q3" value="2" id="q3_2">
                                <label for="q3_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q3" value="3" id="q3_3">
                                <label for="q3_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q3" value="4" id="q3_4">
                                <label for="q3_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q3" value="5" id="q3_5">
                                <label for="q3_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q3" value="6" id="q3_6">
                                <label for="q3_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q3" value="7" id="q3_7">
                                <label for="q3_7">7</label>
                            </div>
                        </div>
                        <div class="likert-labels">
                            <span>Strongly Disagree</span>
                            <span>Strongly Agree</span>
                        </div>
                    </div>

                    <div class="likert-scale">
                        <div class="likert-question">4. I would recommend this product to others.</div>
                        <div class="likert-options">
                            <div class="likert-option">
                                <input type="radio" name="q4" value="1" id="q4_1" required>
                                <label for="q4_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q4" value="2" id="q4_2">
                                <label for="q4_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q4" value="3" id="q4_3">
                                <label for="q4_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q4" value="4" id="q4_4">
                                <label for="q4_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q4" value="5" id="q4_5">
                                <label for="q4_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q4" value="6" id="q4_6">
                                <label for="q4_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q4" value="7" id="q4_7">
                                <label for="q4_7">7</label>
                            </div>
                        </div>
                        <div class="likert-labels">
                            <span>Strongly Disagree</span>
                            <span>Strongly Agree</span>
                        </div>
                    </div>

                    <div class="likert-scale">
                        <div class="likert-question">5. This product represents good value for money.</div>
                        <div class="likert-options">
                            <div class="likert-option">
                                <input type="radio" name="q5" value="1" id="q5_1" required>
                                <label for="q5_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q5" value="2" id="q5_2">
                                <label for="q5_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q5" value="3" id="q5_3">
                                <label for="q5_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q5" value="4" id="q5_4">
                                <label for="q5_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q5" value="5" id="q5_5">
                                <label for="q5_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q5" value="6" id="q5_6">
                                <label for="q5_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="q5" value="7" id="q5_7">
                                <label for="q5_7">7</label>
                            </div>
                        </div>
                        <div class="likert-labels">
                            <span>Strongly Disagree</span>
                            <span>Strongly Agree</span>
                        </div>
                    </div>
                </form>
                
                <button class="btn" onclick="submitStudy()" id="submitBtn" disabled>Submit Responses</button>
            </div>

            <!-- Step 6: Debriefing -->
            <div class="step" id="step6">
                <div class="debriefing">
                    <h2>Thank You for Participating!</h2>
                    <h3>Study Debriefing</h3>
                    
                    <p>Thank you for completing our research study on consumer purchase intention. Your participation is valuable to our research.</p>
                    
                    <h4>Purpose of the Study:</h4>
                    <p>This study examined how product uncertainty affects consumer purchase intentions. Participants were randomly assigned to view either a certain product scenario (specific collectible figure) or an uncertain product scenario (mystery box), and then rated their purchase intentions.</p>
                    
                    <h4>Why This Research Matters:</h4>
                    <p>Understanding how consumers respond to product uncertainty helps businesses make better decisions about product presentation and marketing strategies. Your responses will contribute to academic research in consumer behavior.</p>
                    
                    <h4>Confidentiality:</h4>
                    <p>All your responses have been recorded anonymously. No personal identifying information has been collected or stored.</p>
                    
                    <h4>Questions or Concerns:</h4>
                    <p>If you have any questions about this study or would like to know more about the results, please contact [Researcher Contact Information].</p>
                    
                    <p><strong>Thank you again for your time and participation!</strong></p>
                </div>
            </div>

            <!-- Admin Panel (Hidden) -->
            <div class="step" id="adminPanel" style="display: none;">
                <h2>üîí Researcher Admin Panel</h2>
                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>Data Collection Status</h3>
                    <p><strong>Total Participants:</strong> <span id="totalParticipants">0</span></p>
                    <p><strong>Certain Condition:</strong> <span id="certainCount">0</span></p>
                    <p><strong>Uncertain Condition:</strong> <span id="uncertainCount">0</span></p>
                    <p><strong>Last Updated:</strong> <span id="lastUpdated">Never</span></p>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="downloadAllData()" style="margin-right: 10px;">
                        üìä Download All Data (Excel)
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="background: #e53e3e; color: white;">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
                
                <div style="background: #fff5f5; border: 1px solid #feb2b2; padding: 15px; border-radius: 8px;">
                    <h4>‚ö†Ô∏è Important Notes:</h4>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>Data is stored locally in the browser</li>
                        <li>Download data regularly as backup</li>
                        <li>Clearing browser data will delete all responses</li>
                        <li>Each participant download includes all previous data</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Admin Access Button (Fixed Position) -->
        <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
            <button onclick="toggleAdmin()" style="background: #2d3748; color: white; border: none; padding: 10px; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 18px;">
                üîß
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let currentStep = 1;
        let totalSteps = 6;
        let condition = Math.random() < 0.5 ? 'uncertain' : 'certain';
        let participantData = {
            participantId: 'P' + Date.now() + Math.floor(Math.random() * 1000),
            condition: condition,
            demographics: {},
            responses: {},
            timestamp: new Date().toISOString()
        };

        // Initialize or retrieve existing data from localStorage
        let allParticipantData = JSON.parse(localStorage.getItem('researchData')) || [];

        // Initialize the study
        updateProgress();
        updateStepIndicator();
        
        // Set up the scenario based on condition
        document.addEventListener('DOMContentLoaded', function() {
            setupScenario();
        });

        function setupScenario() {
            const scenarioBox = document.getElementById('scenarioBox');
            if (condition === 'uncertain') {
                scenarioBox.innerHTML = `
                    <strong>Mystery Collectible Box</strong><br>
                    Pay RM25 for a mystery collectible box containing a figure worth RM15-25.<br>
                    You might lose RM10 or break even from this purchase.
                `;
                scenarioBox.classList.remove('certain');
            } else {
                scenarioBox.innerHTML = `
                    <strong>Specific Collectible Figure</strong><br>
                    Pay RM25 for a specific collectible figure worth RM20.<br>
                    You will lose RM5 from this purchase.
                `;
                scenarioBox.classList.add('certain');
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    currentStep++;
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    updateProgress();
                    updateStepIndicator();
                    
                    // Setup scenario when reaching step 4
                    if (currentStep === 4) {
                        setupScenario();
                    }
                }
            }
        }

        function validateCurrentStep() {
            switch(currentStep) {
                case 2:
                    return document.getElementById('consentCheck').checked;
                case 3:
                    const requiredFields = ['age', 'gender', 'education', 'income', 'occupation', 'collectible-experience'];
                    return requiredFields.every(field => document.getElementById(field).value !== '');
                case 5:
                    const questions = ['q1', 'q2', 'q3', 'q4', 'q5'];
                    return questions.every(q => document.querySelector(`input[name="${q}"]:checked`));
                default:
                    return true;
            }
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateStepIndicator() {
            const indicators = [
                'Welcome', 'Consent', 'Demographics', 'Product Scenario', 'Questions', 'Complete'
            ];
            document.getElementById('stepIndicator').textContent = 
                `Step ${currentStep} of ${totalSteps}: ${indicators[currentStep - 1]}`;
        }

        function submitStudy() {
            if (validateCurrentStep()) {
                // Collect demographic data
                participantData.demographics = {
                    age: document.getElementById('age').value,
                    gender: document.getElementById('gender').value,
                    education: document.getElementById('education').value,
                    income: document.getElementById('income').value,
                    occupation: document.getElementById('occupation').value,
                    collectibleExperience: document.getElementById('collectible-experience').value
                };

                // Collect response data
                participantData.responses = {
                    q1: document.querySelector('input[name="q1"]:checked').value,
                    q2: document.querySelector('input[name="q2"]:checked').value,
                    q3: document.querySelector('input[name="q3"]:checked').value,
                    q4: document.querySelector('input[name="q4"]:checked').value,
                    q5: document.querySelector('input[name="q5"]:checked').value
                };

                // Store participant data
                allParticipantData.push(participantData);
                localStorage.setItem('researchData', JSON.stringify(allParticipantData));
                
                // Export to Excel
                exportToExcel();
                
                // Show completion message
                alert('Thank you! Your responses have been recorded and saved to Excel file.');
                
                nextStep();
            }
        }

        function exportToExcel() {
            // Prepare data for Excel
            const excelData = allParticipantData.map(participant => ({
                'Participant ID': participant.participantId,
                'Timestamp': new Date(participant.timestamp).toLocaleString(),
                'Condition': participant.condition,
                'Age': participant.demographics.age,
                'Gender': participant.demographics.gender,
                'Education': participant.demographics.education,
                'Income': participant.demographics.income,
                'Occupation': participant.demographics.occupation,
                'Collectible Experience': participant.demographics.collectibleExperience,
                'Q1 - Consider Buying': participant.responses.q1,
                'Q2 - Would Purchase': participant.responses.q2,
                'Q3 - Strong Intention': participant.responses.q3,
                'Q4 - Would Recommend': participant.responses.q4,
                'Q5 - Good Value': participant.responses.q5,
                'Purchase Intention Mean': (
                    (parseInt(participant.responses.q1) + 
                     parseInt(participant.responses.q2) + 
                     parseInt(participant.responses.q3) + 
                     parseInt(participant.responses.q4) + 
                     parseInt(participant.responses.q5)) / 5
                ).toFixed(2)
            }));

            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create main data sheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Auto-size columns
            const colWidths = [];
            const headerRow = Object.keys(excelData[0] || {});
            headerRow.forEach((header, index) => {
                const maxLength = Math.max(
                    header.length,
                    ...excelData.map(row => String(row[header] || '').length)
                );
                colWidths[index] = { wch: Math.min(maxLength + 2, 50) };
            });
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Research Data');
            
            // Create summary sheet
            const summaryData = createSummaryData();
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary Statistics');
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `Purchase_Intention_Study_${timestamp}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
        }

        function createSummaryData() {
            const certainParticipants = allParticipantData.filter(p => p.condition === 'certain');
            const uncertainParticipants = allParticipantData.filter(p => p.condition === 'uncertain');
            
            const calculateMean = (participants, question) => {
                if (participants.length === 0) return 0;
                const sum = participants.reduce((acc, p) => acc + parseInt(p.responses[question]), 0);
                return (sum / participants.length).toFixed(2);
            };
            
            const calculateOverallMean = (participants) => {
                if (participants.length === 0) return 0;
                const questions = ['q1', 'q2', 'q3', 'q4', 'q5'];
                const totalSum = participants.reduce((acc, p) => {
                    return acc + questions.reduce((qSum, q) => qSum + parseInt(p.responses[q]), 0);
                }, 0);
                return (totalSum / (participants.length * questions.length)).toFixed(2);
            };
            
            return [
                { Metric: 'Total Participants', Value: allParticipantData.length },
                { Metric: 'Certain Condition', Value: certainParticipants.length },
                { Metric: 'Uncertain Condition', Value: uncertainParticipants.length },
                { Metric: '', Value: '' },
                { Metric: 'CERTAIN CONDITION MEANS', Value: '' },
                { Metric: 'Q1 - Consider Buying', Value: calculateMean(certainParticipants, 'q1') },
                { Metric: 'Q2 - Would Purchase', Value: calculateMean(certainParticipants, 'q2') },
                { Metric: 'Q3 - Strong Intention', Value: calculateMean(certainParticipants, 'q3') },
                { Metric: 'Q4 - Would Recommend', Value: calculateMean(certainParticipants, 'q4') },
                { Metric: 'Q5 - Good Value', Value: calculateMean(certainParticipants, 'q5') },
                { Metric: 'Overall Purchase Intention', Value: calculateOverallMean(certainParticipants) },
                { Metric: '', Value: '' },
                { Metric: 'UNCERTAIN CONDITION MEANS', Value: '' },
                { Metric: 'Q1 - Consider Buying', Value: calculateMean(uncertainParticipants, 'q1') },
                { Metric: 'Q2 - Would Purchase', Value: calculateMean(uncertainParticipants, 'q2') },
                { Metric: 'Q3 - Strong Intention', Value: calculateMean(uncertainParticipants, 'q3') },
                { Metric: 'Q4 - Would Recommend', Value: calculateMean(uncertainParticipants, 'q4') },
                { Metric: 'Q5 - Good Value', Value: calculateMean(uncertainParticipants, 'q5') },
                { Metric: 'Overall Purchase Intention', Value: calculateOverallMean(uncertainParticipants) }
            ];
        }

        // Event listeners for form validation
        document.getElementById('consentCheck').addEventListener('change', function() {
            document.getElementById('consentBtn').disabled = !this.checked;
        });

        // Demographics validation
        const demographicFields = ['age', 'gender', 'education', 'income', 'occupation', 'collectible-experience'];
        demographicFields.forEach(field => {
            document.getElementById(field).addEventListener('change', function() {
                const allFilled = demographicFields.every(f => document.getElementById(f).value !== '');
                document.getElementById('demographicsBtn').disabled = !allFilled;
            });
        });

        // Purchase intention form validation
        const form = document.getElementById('purchaseIntentionForm');
        form.addEventListener('change', function() {
            const allAnswered = ['q1', 'q2', 'q3', 'q4', 'q5'].every(q => 
                document.querySelector(`input[name="${q}"]:checked`)
            );
            document.getElementById('submitBtn').disabled = !allAnswered;
        });

        // Admin Panel Functions
        let adminVisible = false;
        
        function toggleAdmin() {
            const adminPanel = document.getElementById('adminPanel');
            const currentStepElement = document.querySelector('.step.active');
            
            if (!adminVisible) {
                // Show admin panel
                if (currentStepElement) currentStepElement.style.display = 'none';
                adminPanel.style.display = 'block';
                updateAdminStats();
                adminVisible = true;
            } else {
                // Hide admin panel
                adminPanel.style.display = 'none';
                if (currentStepElement) currentStepElement.style.display = 'block';
                adminVisible = false;
            }
        }
        
        function updateAdminStats() {
            const data = JSON.parse(localStorage.getItem('researchData')) || [];
            const certainCount = data.filter(p => p.condition === 'certain').length;
            const uncertainCount = data.filter(p => p.condition === 'uncertain').length;
            
            document.getElementById('totalParticipants').textContent = data.length;
            document.getElementById('certainCount').textContent = certainCount;
            document.getElementById('uncertainCount').textContent = uncertainCount;
            
            if (data.length > 0) {
                const lastEntry = data[data.length - 1];
                document.getElementById('lastUpdated').textContent = 
                    new Date(lastEntry.timestamp).toLocaleString();
            }
        }
        
        function downloadAllData() {
            const data = JSON.parse(localStorage.getItem('researchData')) || [];
            
            if (data.length === 0) {
                alert('No data available to download.');
                return;
            }
            
            // Use the existing export function with stored data
            const tempAllData = allParticipantData;
            allParticipantData = data;
            exportToExcel();
            allParticipantData = tempAllData;
            
            alert(`Downloaded data for ${data.length} participants.`);
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear all collected data? This action cannot be undone.')) {
                localStorage.removeItem('researchData');
                allParticipantData = [];
                updateAdminStats();
                alert('All data has been cleared.');
            }
        }
    </script>
</body>
</html>